name: Contract Tests

on:
  push:
    branches: [main, master]
    paths:
      - 'specs/**'
      - 'src/**'
      - '.github/workflows/contract-tests.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'specs/**'
      - 'src/**'
  workflow_dispatch:
    inputs:
      test_level:
        description: 'Test level to generate'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - contract
      environment:
        description: 'Environment to run tests against'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  sync-and-test:
    runs-on: ubuntu-latest
    name: Sync to Spec Hub & Run Contract Tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Validate OpenAPI spec
        run: |
          echo "Validating OpenAPI spec..."
          npx @apidevtools/swagger-parser-cli validate specs/sample-api.yaml

      - name: Sync spec to Postman Spec Hub
        id: sync
        run: |
          echo "Syncing spec to Postman Spec Hub..."
          
          # Run sync and capture output
          node src/spec-hub-sync.js \
            --spec specs/sample-api.yaml \
            --test-level ${{ github.event.inputs.test_level || 'all' }} \
            2>&1 | tee sync-output.txt
          
          # Extract spec name for later use
          SPEC_NAME=$(grep "‚úÖ Spec:" sync-output.txt | sed 's/.*Spec: //')
          echo "spec_name=$SPEC_NAME" >> $GITHUB_OUTPUT
          echo "Synced: $SPEC_NAME"
          
          # Determine which collections to run based on test level
          TEST_LEVEL="${{ github.event.inputs.test_level || 'all' }}"
          if [ "$TEST_LEVEL" = "all" ] || [ "$TEST_LEVEL" = "smoke" ]; then
            echo "run_smoke=true" >> $GITHUB_OUTPUT
          else
            echo "run_smoke=false" >> $GITHUB_OUTPUT
          fi
          if [ "$TEST_LEVEL" = "all" ] || [ "$TEST_LEVEL" = "contract" ]; then
            echo "run_contract=true" >> $GITHUB_OUTPUT
          else
            echo "run_contract=false" >> $GITHUB_OUTPUT
          fi
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}

      - name: Setup Postman CLI
        run: |
          echo "Installing Postman CLI..."
          curl -o- "https://dl-cli.pstmn.io/install/linux64.sh" | sh
          postman --version

      - name: Login to Postman
        run: |
          echo "Logging in to Postman..."
          postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}

      - name: Run smoke tests
        id: smoke-tests
        if: steps.sync.outputs.run_smoke == 'true'
        run: |
          echo "Running smoke tests..."
          
          SPEC_NAME="${{ steps.sync.outputs.spec_name }}"
          ENV_NAME="$SPEC_NAME - ${{ github.event.inputs.environment || 'staging' }} server"
          
          # Get collection UID by name (more reliable than name)
          SMOKE_UID=$(postman collection list \
            --workspace ${{ secrets.POSTMAN_WORKSPACE_ID }} \
            --format json 2>/dev/null | \
            jq -r ".collections[] | select(.name == \"$SPEC_NAME - Smoke Tests\") | .uid")
          
          if [ -z "$SMOKE_UID" ]; then
            echo "‚ùå Smoke test collection not found"
            exit 1
          fi
          
          echo "Collection UID: $SMOKE_UID"
          echo "Environment: $ENV_NAME"
          
          # Update environment with auth token
          postman environment update "$ENV_NAME" \
            --variable auth_token="${{ secrets.API_AUTH_TOKEN }}" \
            --workspace ${{ secrets.POSTMAN_WORKSPACE_ID }}
          
          # Run smoke tests by UID
          postman collection run "$SMOKE_UID" \
            --environment "$ENV_NAME" \
            --reporters cli,junit \
            --reporter-junit-export smoke-results.xml \
            --verbose
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        continue-on-error: true

      - name: Run contract tests
        id: contract-tests
        if: steps.sync.outputs.run_contract == 'true'
        run: |
          echo "Running contract tests..."
          
          SPEC_NAME="${{ steps.sync.outputs.spec_name }}"
          ENV_NAME="$SPEC_NAME - ${{ github.event.inputs.environment || 'staging' }} server"
          
          # Get collection UID by name
          CONTRACT_UID=$(postman collection list \
            --workspace ${{ secrets.POSTMAN_WORKSPACE_ID }} \
            --format json 2>/dev/null | \
            jq -r ".collections[] | select(.name == \"$SPEC_NAME - Contract Tests\") | .uid")
          
          if [ -z "$CONTRACT_UID" ]; then
            echo "‚ùå Contract test collection not found"
            exit 1
          fi
          
          echo "Collection UID: $CONTRACT_UID"
          echo "Environment: $ENV_NAME"
          
          # Update environment with auth token
          postman environment update "$ENV_NAME" \
            --variable auth_token="${{ secrets.API_AUTH_TOKEN }}" \
            --workspace ${{ secrets.POSTMAN_WORKSPACE_ID }}
          
          # Run contract tests by UID
          postman collection run "$CONTRACT_UID" \
            --environment "$ENV_NAME" \
            --reporters cli,junit \
            --reporter-junit-export contract-results.xml \
            --verbose
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ github.run_id }}
          path: |
            smoke-results.xml
            contract-results.xml
            sync-output.txt
          retention-days: 30

      - name: Comment PR with test results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            const smokeOutcome = '${{ steps.smoke-tests.outcome }}';
            const contractOutcome = '${{ steps.contract-tests.outcome }}';
            const specName = '${{ steps.sync.outputs.spec_name }}';
            
            let smokeEmoji = smokeOutcome === 'success' ? '‚úÖ' : smokeOutcome === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';
            let contractEmoji = contractOutcome === 'success' ? '‚úÖ' : contractOutcome === 'skipped' ? '‚è≠Ô∏è' : '‚ùå';
            
            const body = `## üî¨ Contract Test Results
            
            **Spec:** ${specName}
            **Commit:** ${context.sha.substring(0, 7)}
            
            | Test Type | Status |
            |-----------|--------|
            | ${smokeEmoji} Smoke Tests | ${smokeOutcome} |
            | ${contractEmoji} Contract Tests | ${contractOutcome} |
            
            **What was tested:**
            - Status code validation
            - Response time thresholds
            - Content-Type headers
            - JSON Schema structure
            - Required fields
            - Enum values
            - Format patterns (date-time, email, UUID)
            - String/numeric constraints
            
            <details>
            <summary>View Sync Output</summary>
            
            \`\`\`
            ${fs.readFileSync('sync-output.txt', 'utf8').substring(0, 2000)}
            \`\`\`
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      - name: Fail workflow if tests failed
        if: |
          (steps.smoke-tests.outcome == 'failure' && steps.sync.outputs.run_smoke == 'true') ||
          (steps.contract-tests.outcome == 'failure' && steps.sync.outputs.run_contract == 'true')
        run: |
          echo "‚ùå Tests failed!"
          exit 1

  spec-diff:
    runs-on: ubuntu-latest
    name: Spec Change Report
    needs: sync-and-test
    if: github.event_name == 'pull_request' && always()
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Parse PR spec
        id: parse-pr
        run: |
          # Extract info from PR spec
          PR_INFO=$(node -e "
            const yaml = require('yaml');
            const fs = require('fs');
            const spec = yaml.parse(fs.readFileSync('specs/sample-api.yaml', 'utf8'));
            console.log(JSON.stringify({
              title: spec.info?.title || 'Unknown',
              version: spec.info?.version || 'unknown',
              endpoints: Object.entries(spec.paths || {}).flatMap(([path, methods]) => 
                Object.entries(methods).filter(([m]) => !m.startsWith('x-')).map(([method, op]) => ({
                  method: method.toUpperCase(),
                  path: path,
                  summary: op?.summary || ''
                }))
              )
            }));
          ")
          echo "pr_info=$PR_INFO" >> $GITHUB_OUTPUT

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          path: base-branch

      - name: Parse base spec
        id: parse-base
        run: |
          cd base-branch
          # Extract info from base spec
          BASE_INFO=$(node -e "
            const yaml = require('yaml');
            const fs = require('fs');
            const spec = yaml.parse(fs.readFileSync('specs/sample-api.yaml', 'utf8'));
            console.log(JSON.stringify({
              title: spec.info?.title || 'Unknown',
              version: spec.info?.version || 'unknown',
              endpoints: Object.entries(spec.paths || {}).flatMap(([path, methods]) => 
                Object.entries(methods).filter(([m]) => !m.startsWith('x-')).map(([method, op]) => ({
                  method: method.toUpperCase(),
                  path: path,
                  summary: op?.summary || ''
                }))
              )
            }));
          ")
          echo "base_info=$BASE_INFO" >> $GITHUB_OUTPUT

      - name: Generate diff report
        id: diff
        run: |
          node -e "
            const pr = ${{ steps.parse-pr.outputs.pr_info }};
            const base = ${{ steps.parse-base.outputs.base_info }};
            
            const prEndpoints = new Set(pr.endpoints.map(e => \`\${e.method} \${e.path}\`));
            const baseEndpoints = new Set(base.endpoints.map(e => \`\${e.method} \${e.path}\`));
            
            const added = [...prEndpoints].filter(e => !baseEndpoints.has(e));
            const removed = [...baseEndpoints].filter(e => !prEndpoints.has(e));
            
            console.log('## üìä Spec Change Report\\n');
            console.log(\`**Title:** \${pr.title}\`);
            console.log(\`**Version:** \${base.version} ‚Üí \${pr.version}\\n\`);
            
            console.log('| Metric | Count |');
            console.log('|--------|-------|');
            console.log(\`| PR Branch Endpoints | \${pr.endpoints.length} |\`);
            console.log(\`| Base Branch Endpoints | \${base.endpoints.length} |\`);
            console.log(\`| Added | \${added.length} |\`);
            console.log(\`| Removed | \${removed.length} |\\n\`);
            
            if (added.length > 0) {
              console.log('### ‚úÖ Added Endpoints');
              added.forEach(e => console.log(\`- \${e}\`));
              console.log('');
            }
            
            if (removed.length > 0) {
              console.log('### ‚ö†Ô∏è Removed Endpoints');
              removed.forEach(e => console.log(\`- \${e}\`));
              console.log('');
            }
            
            console.log('**Impact:**');
            console.log('- New endpoints ‚Üí Contract tests auto-generated');
            console.log('- Removed endpoints ‚Üí Tests cleanly removed (no orphans)');
            console.log('- Schema changes ‚Üí Tests update to match');
          " > diff-report.md
          
          cat diff-report.md

      - name: Comment PR with diff report
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diffReport = fs.readFileSync('diff-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: diffReport
            });
