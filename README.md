# Spec-Derived Contract Test Generator

A demo tool that showcases Postman Spec Hub native workflows with spec-driven contract test generation. Upload OpenAPI specs to Spec Hub, generate collections natively, and inject contract tests that persist across spec updates.

> **Note:** This demo is designed for Postman Enterprise prospects to showcase spec-driven testing workflows using Postman's native [Spec Hub](https://learning.postman.com/docs/designing-and-developing-your-api/spec-hub/) capabilities.

## ğŸ¯ Problem Statement

When teams use OpenAPI specs as their source of truth, they face a common challenge:

**The Traditional Anti-Pattern:**
1. Upload spec to Spec Hub â†’ generate collection
2. Fork collection â†’ manually write tests
3. Spec updates â†’ collection regenerates
4. **Tests are lost** (or cause merge conflicts)

**The Solution**: Use Spec Hub's native collection generation with **test injection**. Tests are added to Spec Hub-generated collections and **persist** when the spec updates and collections re-generate.

## âœ¨ Features

- **Spec Hub native**: Upload specs directly to Postman Spec Hub
- **Native collection generation**: Collections generated by Spec Hub (not locally)
- **Test injection**: Contract tests injected into Spec Hub collections
- **Test persistence**: Tests survive spec updates and collection re-generation
- **Dual collections**: Separate docs collection (clean) and test collection (with assertions)
- **Contract test generation**: Status codes, schemas, required fields, performance
- **Postman CLI ready**: Works with modern Postman CLI

## ğŸ“‹ Prerequisites

- Node.js 18+ 
- [Postman CLI](https://learning.postman.com/docs/postman-cli/postman-cli-installation/) installed
- Postman API key with Spec Hub access
- Target workspace with Spec Hub enabled

## ğŸš€ Quick Start

### 1. Install Dependencies

```bash
cd demo
npm install
```

### 2. Configure Environment

```bash
export POSTMAN_API_KEY="your-api-key"
export POSTMAN_WORKSPACE_ID="your-workspace-id"
```

### 3. Sync Spec to Spec Hub

```bash
# Upload spec, generate collections, inject tests
npm run sync:spec-hub -- --spec specs/sample-api.yaml
```

This will:
1. Upload spec to Spec Hub (or update existing)
2. Generate docs collection (clean, no tests)
3. Generate test collection
4. Inject contract tests into test collection
5. Create/update environment

### 4. Run Tests with Postman CLI

```bash
# Login to Postman (first time only)
postman login

# Run the test collection
postman collection run "Task Management API - Tests"
```

## ğŸ“– Usage

### Spec Hub Sync (Recommended)

```bash
node src/spec-hub-sync.js --spec <path> [options]

Options:
  --spec, -s        Path to OpenAPI spec file (required)
  --workspace, -w   Postman workspace ID (default: env.POSTMAN_WORKSPACE_ID)
  --api-key, -k     Postman API key (default: env.POSTMAN_API_KEY)
  --dry-run, -d     Validate spec without uploading
  --help, -h        Show help message
```

### Legacy Local Generation

For standalone use without Spec Hub:

```bash
node src/index.js --spec specs/sample-api.yaml
```

## ğŸ§ª Demo Scenarios

### Scenario 1: Initial Sync

```bash
npm run sync:spec-hub -- --spec specs/sample-api.yaml
```

**Result:**
- Spec uploaded to Spec Hub
- "Task Management API - Docs" collection generated (clean)
- "Task Management API - Tests" collection generated with contract tests
- Environment created with variables

### Scenario 2: Spec Update

1. Edit `specs/sample-api.yaml` (add endpoint, change schema, etc.)
2. Re-run sync:
   ```bash
   npm run sync:spec-hub -- --spec specs/sample-api.yaml
   ```

**Result:**
- Spec updated in Spec Hub
- Collections re-generated
- **Contract tests persist** (validated!)
- No orphaned tests, no manual intervention

### Scenario 3: Add Required Field

1. Add new required field to response schema in spec
2. Re-run sync
3. **Result:** New validation automatically included in contract tests

## ğŸ”§ Architecture

```
OpenAPI Spec (GitHub)
    â”‚
    â–¼
Upload to Spec Hub
    â”‚
    â”œâ”€â”€â–¶ Spec Hub generates "Docs" collection (clean)
    â”‚
    â””â”€â”€â–¶ Spec Hub generates "Tests" collection
            â”‚
            â””â”€â”€â–¶ Inject contract tests via API
                    â”‚
                    â””â”€â”€â–¶ Tests persist on spec updates
```

## â˜ï¸ Spec Hub Workflow

### Current Approach: Spec Hub Native

```bash
# Login to Postman (first time only)
postman login --with-api-key $POSTMAN_API_KEY

# Sync spec to Spec Hub
npm run sync:spec-hub -- --spec specs/api.yaml

# This command:
# 1. Uploads/updates spec in Spec Hub
# 2. Generates docs collection (via Spec Hub API)
# 3. Generates test collection (via Spec Hub API)
# 4. Injects contract tests into test collection
# 5. Creates/updates environment
```

### Output Structure

```
Postman Workspace
â”œâ”€â”€ Spec: Task Management API (in Spec Hub)
â”œâ”€â”€ Collection: Task Management API - Docs (clean, Spec Hub generated)
â”œâ”€â”€ Collection: Task Management API - Tests (with contract tests)
â””â”€â”€ Environment: Task Management API Environment
```

## ğŸ” Authentication

The generated collections support authentication via environment variables:

```bash
# Set auth token
postman environment update "Task Management API Environment" \
  --variable auth_token=your-jwt-token
```

## ğŸ”„ CI/CD Integration

See `.github/workflows/contract-tests.yml` for a complete example:

```yaml
name: Contract Tests

on:
  push:
    paths:
      - 'specs/**'

jobs:
  sync-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Login to Postman
        run: postman login --with-api-key ${{ secrets.POSTMAN_API_KEY }}
        
      - name: Sync spec to Spec Hub
        run: npm run sync:spec-hub -- --spec specs/api.yaml
        env:
          POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
          POSTMAN_WORKSPACE_ID: ${{ secrets.POSTMAN_WORKSPACE_ID }}
        
      - name: Run contract tests
        run: |
          postman collection run "Task Management API - Tests" \
            --environment "Task Management API Environment" \
            --reporters cli,junit \
            --reporter-junit-export test-results.xml
```

## ğŸ“Š Test Generation Logic

For each endpoint, the following contract tests are generated:

| Test Type | Trigger | Generated Test |
|-----------|---------|----------------|
| Status Code | `responses: {200: ...}` | `pm.response.to.have.status(200)` |
| Response Time | Always | `pm.expect(pm.response.responseTime).to.be.below(threshold)` |
| Content-Type | `content: application/json` | Header validation |
| JSON Schema | Response schema defined | Structure validation |
| Required Fields | `required: ["id", "name"]` | Field existence checks |
| Error Structure | 4xx responses defined | Error field validation |

## ğŸ¯ Positioning vs. Spec Hub Native Features

| Feature | Spec Hub Native | This Tool |
|---------|----------------|-----------|
| Spec storage | âœ… Yes | âœ… Uses Spec Hub |
| Collection generation | âœ… Yes | âœ… Uses Spec Hub |
| **Contract test generation** | âŒ No | âœ… Injects tests |
| **Test persistence** | N/A | âœ… Validated |
| **Dual collections** (docs + tests) | âŒ No | âœ… Yes |
| CI/CD integration | âš ï¸ Manual | âœ… Automated |

**Use this when**: You need contract tests on Spec Hub-generated collections that persist across spec updates.

## ğŸ› ï¸ Development

### Project Structure

```
demo/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ spec-hub-client.js    # Spec Hub API client
â”‚   â”œâ”€â”€ spec-hub-sync.js      # Main orchestrator
â”‚   â”œâ”€â”€ test-generator.js     # Contract test generator
â”‚   â”œâ”€â”€ parser.js             # OpenAPI parser
â”‚   â”œâ”€â”€ index.js              # Legacy CLI entry point
â”‚   â””â”€â”€ api-uploader.js       # Legacy uploader (deprecated)
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ validate-test-persistence.js  # Validation script
â”‚   â”œâ”€â”€ cleanup-collections.js        # Cleanup orphaned collections
â”‚   â””â”€â”€ cleanup-specs.js              # Cleanup orphaned specs
â”œâ”€â”€ specs/
â”‚   â””â”€â”€ sample-api.yaml       # Demo OpenAPI spec
â”œâ”€â”€ output/                   # Generated files (gitignored)
â”œâ”€â”€ postman/                  # For workspace push compatibility
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md
â””â”€â”€ CLAUDE.md
```

### Available Scripts

```bash
# Sync spec to Spec Hub (recommended)
npm run sync:spec-hub -- --spec specs/api.yaml

# Validate spec
npm run validate:spec -- specs/api.yaml

# Legacy local generation
npm run generate -- --spec specs/api.yaml

# Validate test persistence behavior
npm run validate:test-persistence

# Cleanup orphaned resources
node scripts/cleanup-collections.js
node scripts/cleanup-specs.js
```

## ğŸ“ Sample API

The included `specs/sample-api.yaml` is a Task Management API with:

- **7 endpoints** covering CRUD operations
- **Multiple response codes**: 200, 201, 204, 400, 404, 409, 422
- **Request/response schemas** with required fields
- **Response examples**
- **Authentication** (Bearer token)
- **Public endpoint** (health check)

## ğŸ“„ License

MIT

## ğŸ”— Resources

- [Postman Spec Hub Documentation](https://learning.postman.com/docs/designing-and-developing-your-api/spec-hub/)
- [Postman CLI Documentation](https://learning.postman.com/docs/postman-cli/postman-cli-overview/)
- [Postman API Reference](https://www.postman.com/postman/workspace/postman-public-workspace/documentation/12959542-c8142d51-e97c-46b6-bd77-52bb66712c9a)
